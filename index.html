<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å­¸æ—…å®šåƒ¹ç­–ç•¥</title>
  <style>
    :root{
      --bg:#f6f3f1;
      --panel:#ffffff;
      --text:#1b1b1b;
      --muted:#6e6e6e;
      --line:rgba(0,0,0,.08);
      --shadow:0 18px 50px rgba(0,0,0,.08);
      --radius:26px;

      --warm:#fff2ea;
      --cool:#eef7ff;
      --sand:#f7f1ea;
      --green:#eef8ef;

      --orange:#ff6a2b;
      --gold:#ffb020;
      --ok:#2fb86b;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      padding:26px;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;
      color:var(--text);
      background:
        radial-gradient(circle at 20% 10%, #fde3d6 0%, transparent 55%),
        radial-gradient(circle at 85% 80%, #e1f0e5 0%, transparent 55%),
        var(--bg);
    }
    .app{ max-width:980px; margin:0 auto; }

    .topbar{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:16px; margin-bottom:16px;
    }
    h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .subtitle{ margin:6px 0 0; color:var(--muted); font-size:13px; }

    .segmented{
      display:flex; gap:10px;
      background:rgba(255,255,255,.65);
      border:1px solid var(--line);
      padding:10px;
      border-radius:999px;
      box-shadow:0 12px 30px rgba(0,0,0,.05);
    }
    .segBtn{
      border:none; background:transparent;
      font-weight:900; padding:10px 14px;
      border-radius:999px; cursor:pointer;
      color:rgba(0,0,0,.55);
    }
    .segBtn.active{
      background:linear-gradient(180deg, #ff7a36, #ff5f1f);
      color:#fff;
      box-shadow:0 10px 24px rgba(255,95,31,.25);
    }

    .grid2{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:14px;
      margin-bottom:16px;
    }
    @media (max-width: 760px){
      body{padding:16px}
      .topbar{flex-direction:column; align-items:flex-start}
      .grid2{grid-template-columns:1fr}
    }

    .statCard{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .statCard.warm{ background:linear-gradient(180deg, var(--warm), #fff); }
    .statCard.cool{ background:linear-gradient(180deg, #eef7ff, #fff); }
    .statCard.sand{ background:linear-gradient(180deg, var(--sand), #fff); }
    .statCard.green{ background:linear-gradient(180deg, var(--green), #fff); }

    .statHead{ display:flex; gap:12px; align-items:flex-start; }
    .statIcon{
      width:42px;height:42px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      font-size:18px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:0 10px 20px rgba(0,0,0,.06);
    }
    .statLabel{ font-size:12px; color:rgba(0,0,0,.55); font-weight:900; }
    .statValue{ font-size:24px; font-weight:950; margin-top:4px; }
    .statSub{ margin-top:6px; font-size:12px; color:rgba(0,0,0,.55); }

    .statViz{
      margin-top:14px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:14px;
      flex-wrap:wrap;
    }

    .ringWrap{ position:relative; width:78px; height:78px; }
    .ring{
      width:78px;height:78px;border-radius:999px;
      background: conic-gradient(var(--orange) 0deg, rgba(0,0,0,.06) 0deg);
      box-shadow:0 10px 22px rgba(0,0,0,.08);
    }
    .ring.warn{ background: conic-gradient(var(--gold) 0deg, rgba(0,0,0,.06) 0deg); }
    .ring.ok{ background: conic-gradient(var(--ok) 0deg, rgba(0,0,0,.06) 0deg); }

    .ringCenter{
      position:absolute; inset:10px;
      border-radius:999px;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.06);
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      text-align:center;
    }
    .ringPct{ font-size:13px; font-weight:950; }
    .ringNote{ margin-top:2px; font-size:10px; color:rgba(0,0,0,.55); font-weight:900; }

    .underNote{
      margin-top:10px;
      font-size:12px;
      color:rgba(0,0,0,.55);
      background:rgba(0,0,0,.03);
      border:1px solid rgba(0,0,0,.06);
      padding:10px 12px;
      border-radius:18px;
    }

    .pill{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.06);
      background:rgba(255,255,255,.75);
      font-size:12px; font-weight:900;
      color:rgba(0,0,0,.62);
      box-shadow:0 10px 20px rgba(0,0,0,.05);
    }
    .pill.big{ width:100%; text-align:center; font-size:13px; }

    .miniStack{
      width:220px;
      height:14px;
      border-radius:999px;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 10px 20px rgba(0,0,0,.05);
      overflow:hidden;
      display:flex;
    }
    .miniStack span{ height:100%; }

    .spark{
      width:220px; height:60px; border-radius:18px;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 10px 22px rgba(0,0,0,.06);
      overflow:hidden;
    }
    .spark svg{ width:100%; height:100%; }

    .panel{
      background:rgba(255,255,255,.72);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      margin-bottom:16px;
    }
    .panelHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:12px;
    }
    .panelHead h2{ margin:0; font-size:16px; letter-spacing:.2px; }

    .ghostBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,.06);
    }

    .formGrid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 760px){
      .formGrid{ grid-template-columns:1fr; }
    }

    .box{
      background:#fff;
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px;
      box-shadow:0 12px 26px rgba(0,0,0,.06);
    }
    .boxTitle{ font-weight:950; letter-spacing:.2px; margin-bottom:10px; }

    .row{ margin-bottom:10px; }
    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    @media (max-width: 760px){ .row2{ grid-template-columns:1fr; } }

    label{
      display:block;
      font-size:12px;
      color:rgba(0,0,0,.60);
      font-weight:900;
      margin-bottom:6px;
    }

    input{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      outline:none;
      font-size:13px;
      box-shadow:0 10px 20px rgba(0,0,0,.05);
      background:#fff;
    }

    /* placeholder æ·¡ç° */
    input::placeholder{
      color: rgba(0,0,0,.30);
      font-weight:900;
    }

    .money{
      display:flex; align-items:center; gap:8px;
      padding:0 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:0 10px 20px rgba(0,0,0,.05);
    }
    .money input{
      border:none; box-shadow:none;
      padding:12px 6px;
      background:transparent;
    }
    .money .unit{
      font-size:12px; color:rgba(0,0,0,.45);
      font-weight:950;
      user-select:none;
      white-space:nowrap;
    }

    .inline{ display:flex; align-items:center; gap:10px; }
    .unit2{ font-weight:900; color:rgba(0,0,0,.50); }

    .note{
      margin-top:10px;
      font-size:12px;
      color:rgba(0,0,0,.55);
      background:rgba(0,0,0,.03);
      border:1px solid rgba(0,0,0,.06);
      padding:10px 12px;
      border-radius:18px;
    }

    .range{ display:flex; align-items:center; gap:10px; }
    .range input{ width:82px; padding:10px 10px; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border-radius:20px;
      background:#fff;
      border:1px solid var(--line);
      box-shadow:0 10px 22px rgba(0,0,0,.05);
    }
    .left{ display:flex; align-items:center; gap:12px; min-width:0; }
    .badge{
      width:36px;height:36px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      border:1px solid rgba(0,0,0,.06);
      background:rgba(0,0,0,.03);
    }
    .meta{ min-width:0; }
    .meta .t{ font-weight:950; font-size:13px; }
    .meta .s{
      margin-top:4px;
      font-size:11px;
      color:rgba(0,0,0,.55);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:520px;
    }
    .right{ text-align:right; }
    .right .gm{ font-weight:950; font-size:14px; }
    .right .gp{ margin-top:4px; font-size:11px; color:rgba(0,0,0,.55); }

    .muted{ color:var(--muted); }
    .footer{ text-align:center; padding:8px 0 0; font-size:12px; }
  </style>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div>
        <h1>å­¸æ—…å®šåƒ¹ç­–ç•¥</h1>
        <p class="subtitle">è¼¸å…¥äººæ•¸èˆ‡æˆæœ¬å¾Œï¼Œè‡ªå‹•è©¦ç®—ã€Œå»ºè­°å”®åƒ¹ / æˆåœ˜ç·š / æ¯›åˆ©ç‡ã€</p>
      </div>

      <div class="segmented">
        <button class="segBtn active" id="modeInclude" type="button">å«æ©Ÿç¥¨</button>
        <button class="segBtn" id="modeExclude" type="button">ä¸å«æ©Ÿç¥¨</button>
      </div>
    </header>

    <section class="grid2">
      <article class="statCard warm">
        <div class="statHead">
          <div class="statIcon">ğŸ’°</div>
          <div>
            <div class="statLabel">å¹³å‡å”®åƒ¹</div>
            <div class="statValue" id="avgPriceTxt">NT$ â€”</div>
            <div class="statSub">
              ä¸€èˆ¬ <span id="cntNormalTxt">â€”</span>ï½œæ—©é³¥ <span id="cntEarlyTxt">â€”</span>ï½œå­¸å“¡ <span id="cntStudentTxt">â€”</span>
            </div>
          </div>
        </div>

        <div class="statViz">
          <div class="ringWrap">
            <div class="ring" id="ring15"></div>
            <div class="ringCenter">
              <div class="ringPct" id="gm15Txt">â€”</div>
              <div class="ringNote">15äººæ¯›åˆ©ç‡</div>
            </div>
          </div>

          <div class="ringWrap">
            <div class="ring warn" id="ring17"></div>
            <div class="ringCenter">
              <div class="ringPct" id="gm17Txt">â€”</div>
              <div class="ringNote">17äººæ¯›åˆ©ç‡</div>
            </div>
          </div>
        </div>

        <div class="underNote" id="peopleHint">å»ºè­°å‡ºåœ˜ï¼š17äºº</div>
      </article>

      <article class="statCard cool">
        <div class="statHead">
          <div class="statIcon">ğŸ§¾</div>
          <div>
            <div class="statLabel">æ¯äººæˆæœ¬</div>
            <div class="statValue" id="costPerTxt">NT$ â€”</div>
            <div class="statSub" id="feeSubTxt">å°¾æ¬¾åˆ·å¡å¹³å‡æ‰‹çºŒè²»ï¼šNT$ â€” / äºº</div>
          </div>
        </div>

        <div class="statViz">
          <div class="miniStack" id="costStack"></div>
        </div>

        <div class="underNote" id="busHint">â€”</div>
      </article>

      <article class="statCard sand">
        <div class="statHead">
          <div class="statIcon">ğŸš¦</div>
          <div>
            <div class="statLabel">æœ€ä½æˆåœ˜</div>
            <div class="statValue" id="breakevenTxt">â€”</div>
            <div class="statSub">ä»¥ä½ ç›®å‰è¼¸å…¥çš„å”®åƒ¹èˆ‡æˆæœ¬ä¼°ç®—</div>
          </div>
        </div>

        <div class="statViz">
          <div class="ringWrap">
            <div class="ring warn" id="ringTarget"></div>
            <div class="ringCenter">
              <div class="ringPct" id="gmTargetTxt">â€”</div>
              <div class="ringNote">ç›®æ¨™äººæ•¸æ¯›åˆ©ç‡</div>
            </div>
          </div>

          <div class="pill" id="riskPill">â€”</div>
        </div>

        <div class="underNote">ç›®æ¨™æ¯›åˆ©ç‡ï¼š<span id="targetGmTxt">â€”</span></div>
      </article>

      <article class="statCard green">
        <div class="statHead">
          <div class="statIcon">ğŸ¯</div>
          <div>
            <div class="statLabel">è¦ã€Œ15äººæˆåœ˜ã€å»ºè­°ä¸€èˆ¬åƒ¹</div>
            <div class="statValue" id="suggestNormalTxt">NT$ â€”</div>
            <div class="statSub">å›ºå®šç”¨å°¾æ•¸ 980</div>
          </div>
        </div>

        <div class="statViz">
          <div class="spark" id="sparkMargin"></div>
        </div>

        <div class="underNote">æ›²ç·šï¼šäººæ•¸ç¯„åœå…§æ¯›åˆ©ç‡è®ŠåŒ–</div>
      </article>
    </section>

    <section class="panel">
      <div class="panelHead">
        <h2>è¼¸å…¥å€</h2>
        <button class="ghostBtn" id="resetBtn" type="button">æ¸…ç©º</button>
      </div>

      <div class="formGrid">
        <div class="box">
          <div class="boxTitle">äººæ•¸</div>

          <div class="row2">
            <div>
              <label>ç›®æ¨™äººæ•¸</label>
              <input id="targetPeople" type="number" min="1" placeholder="å»ºè­°ï¼š20">
            </div>
            <div>
              <label>å¸Œæœ›æˆåœ˜äººæ•¸</label>
              <input id="desiredPeople" type="number" min="1" placeholder="å»ºè­°ï¼š15">
            </div>
          </div>

          <div class="row2">
            <div>
              <label>æ—©é³¥äººæ•¸</label>
              <input id="earlyCount" type="number" min="0" placeholder="å»ºè­°ï¼š0ï½10">
            </div>
            <div>
              <label>å­¸å“¡äººæ•¸</label>
              <input id="studentCount" type="number" min="0" placeholder="å»ºè­°ï¼š0ï½10">
            </div>
          </div>

          <div class="note" id="capNote">å»ºè­°å‡ºåœ˜äººæ•¸ï¼š17äººï¼ˆç›®å‰å·´å£«å¯è¼‰å­¸ç”Ÿä¸Šé™ï¼‰</div>
        </div>

        <div class="box">
          <div class="boxTitle">å”®åƒ¹</div>

          <div class="row">
            <label>ä¸€èˆ¬åƒ¹</label>
            <div class="money">
              <span class="unit">NT$</span>
              <input id="priceNormal" type="text" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š45,800ï¼ˆæˆ–å¡«ä½ é è¨ˆçš„å”®åƒ¹ï¼‰">
            </div>
          </div>

          <div class="row2">
            <div>
              <label>æ—©é³¥æŠ˜æ‰£</label>
              <div class="money">
                <span class="unit">NT$</span>
                <input id="earlyDiscount" type="text" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š1,000ï½3,000">
              </div>
            </div>
            <div>
              <label>æ—©é³¥åƒ¹</label>
              <div class="pill big" id="priceEarlyTxt">NT$ â€”</div>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>å­¸å“¡åƒ¹åŠ æˆ</label>
              <div class="money">
                <span class="unit">NT$</span>
                <input id="studentBuffer" type="text" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š0ï½2,000ï¼ˆå­¸å“¡åƒ¹é€šå¸¸æ¥è¿‘æˆæœ¬ï¼‰">
              </div>
            </div>
            <div>
              <label>å­¸å“¡åƒ¹</label>
              <div class="pill big" id="priceStudentTxt">NT$ â€”</div>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>ç›®æ¨™æ¯›åˆ©ç‡</label>
              <div class="inline">
                <input id="targetGM" type="number" min="0" max="95" placeholder="ä¾‹å¦‚ï¼š20">
                <span class="unit2">%</span>
              </div>
            </div>
            <div>
              <label>å®šåƒ¹å°¾æ•¸</label>
              <div class="pill big">å›ºå®šï¼šå°¾æ•¸ 980</div>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="boxTitle">æ¯äººæˆæœ¬</div>

          <div class="row2">
            <div>
              <label>æ—¥æ–¹</label>
              <div class="money">
                <span class="unit">NT$</span>
                <input id="costJapan" type="text" inputmode="numeric" placeholder="å»ºè­°ï¼š23,000ï½27,000">
              </div>
            </div>
            <div>
              <label>æ©Ÿç¥¨</label>
              <div class="money">
                <span class="unit">NT$</span>
                <input id="costFlight" type="text" inputmode="numeric" placeholder="ä¾¿å®œï¼š9,000ï½12,000ï½œè²´ï¼š16,000ï½18,000">
              </div>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>ä¿éšª</label>
              <div class="money">
                <span class="unit">NT$</span>
                <input id="costInsurance" type="text" inputmode="numeric" placeholder="å»ºè­°ï¼š550ï½650">
              </div>
            </div>
            <div>
              <label>ç¶²å¡</label>
              <div class="money">
                <span class="unit">NT$</span>
                <input id="costSim" type="text" inputmode="numeric" placeholder="å»ºè­°ï¼š250ï½300">
              </div>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>æ‰‹å†Š</label>
              <div class="money">
                <span class="unit">NT$</span>
                <input id="costBook" type="text" inputmode="numeric" placeholder="å»ºè­°ï¼š90ï½110">
              </div>
            </div>
            <div>
              <label>å¤§å‹å·´å£«è¿½åŠ è²»ï¼ˆæ¯äººï¼‰</label>
              <div class="money">
                <span class="unit">NT$</span>
                <input id="bigBusExtraPer" type="text" inputmode="numeric" placeholder="è‹¥è¶…é17äººå¯èƒ½éœ€è¦ï¼Œä¾‹å¦‚ï¼š1,000ï½3,000">
              </div>
            </div>
          </div>

          <div class="row">
            <label>å…¶ä»–æ¯äºº</label>
            <div class="money">
              <span class="unit">NT$</span>
              <input id="costExtraPer" type="text" inputmode="numeric" placeholder="æ²’æœ‰å°±ç•™ç©º">
            </div>
          </div>
        </div>

        <div class="box">
          <div class="boxTitle">å»£å‘Šèˆ‡åˆ·å¡</div>

          <div class="row2">
            <div>
              <label>æ¯ä½å ±åå»£å‘Šæˆæœ¬</label>
              <div class="money">
                <span class="unit">NT$</span>
                <input id="adCostPerSignup" type="text" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š1,500ï½3,500">
              </div>
            </div>
            <div>
              <label>å…¶ä»–å›ºå®šè²»</label>
              <div class="money">
                <span class="unit">NT$</span>
                <input id="fixedOther" type="text" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼šåŒ¯æ¬¾/åŒ¯å·®/å°åˆ·ç­‰ï¼ˆæ²’æœ‰å°±ç•™ç©ºï¼‰">
              </div>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>è¨‚é‡‘ï¼ˆå›ºå®šï¼‰</label>
              <div class="pill big">NT$ 15,000</div>
            </div>
            <div>
              <label>å°¾æ¬¾åˆ·å¡äººæ•¸</label>
              <input id="cardCount" type="number" min="0" placeholder="åˆ·å¡é€šå¸¸ä½æ–¼10%ï¼Œä¾‹å¦‚ï¼š0ï½2">
            </div>
          </div>

          <div class="row2">
            <div>
              <label>æ‰‹çºŒè²»ç‡</label>
              <div class="inline">
                <input id="cardFeeRate" type="number" min="0" max="10" step="0.1" placeholder="ä¾‹å¦‚ï¼š2.4">
                <span class="unit2">%</span>
              </div>
            </div>
            <div>
              <label>å›ºå®šæˆæœ¬</label>
              <div class="pill big" id="fixedTxt">NT$ â€”</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panelHead">
        <h2>äººæ•¸ â†’ æ¯›åˆ©ç‡</h2>
        <div class="range">
          <span class="muted">ç¯„åœ</span>
          <input id="rangeFrom" type="number" min="1" placeholder="ä¾‹å¦‚ï¼š10">
          <span class="muted">ï½</span>
          <input id="rangeTo" type="number" min="1" placeholder="ä¾‹å¦‚ï¼š28">
        </div>
      </div>

      <div class="list" id="marginList"></div>
    </section>

    <footer class="footer">
      <div class="muted">ï¼Šé‡‘é¡æ¬„ä½æœƒè‡ªå‹•åŠ ä¸Šåƒåˆ†ä½é€—è™Ÿ</div>
    </footer>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const $ = (id) => document.getElementById(id);
      let ticketMode = "include";
      const RECOMMENDED_CAP = 17;
      const DEPOSIT = 15000;
      const FIXED_ENDING = 980;

      function parseMoney(v){
        const s = String(v ?? "").replace(/,/g,"").replace(/[^\d]/g,"");
        return s ? Number(s) : NaN;
      }
      function fmtMoney(n){
        if (!Number.isFinite(n)) return "NT$ â€”";
        return "NT$ " + Math.round(n).toLocaleString("zh-TW");
      }
      function fmtPct(p){
        if (!Number.isFinite(p)) return "â€”";
        return (p*100).toFixed(1) + "%";
      }
      function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

      function formatCommaKeepCursor(input){
        const old = input.value;
        const oldPos = input.selectionStart ?? old.length;
        const digitsLeft = old.slice(0, oldPos).replace(/[^\d]/g,'').length;

        const cleaned = old.replace(/,/g,'').replace(/[^\d]/g,'');
        const formatted = cleaned ? Number(cleaned).toLocaleString('zh-TW') : "";
        input.value = formatted;

        let pos = 0, seen = 0;
        while (pos < formatted.length && seen < digitsLeft){
          if (/\d/.test(formatted[pos])) seen++;
          pos++;
        }
        input.setSelectionRange(pos,pos);
      }

      function setRing(el, pct, colorVar){
        const deg = clamp(pct,0,1) * 360;
        el.style.background = `conic-gradient(${colorVar} 0deg ${deg}deg, rgba(0,0,0,.06) ${deg}deg 360deg)`;
      }

      function setMiniStack(el, parts){
        const total = parts.reduce((a,p)=>a+p.value, 0) || 1;
        el.innerHTML = "";
        parts.forEach(p=>{
          const span = document.createElement("span");
          span.style.width = (p.value/total*100).toFixed(2) + "%";
          span.style.background = p.color;
          el.appendChild(span);
        });
      }

      function makeLineSVG(el, points){
        const w = 220, h = 60, pad = 10;
        if (!points.length) { el.innerHTML = ""; return; }
        const xs = points.map((_,i)=> pad + (i*(w-2*pad)/(points.length-1)));
        const ys = points.map(v => pad + (1-v)*(h-2*pad));
        const d = xs.map((x,i)=> `${i===0?'M':'L'} ${x.toFixed(2)} ${ys[i].toFixed(2)}`).join(" ");
        el.innerHTML = `
          <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
            <path d="${d}" fill="none" stroke="rgba(47,184,107,.85)" stroke-width="3" stroke-linecap="round"/>
            <path d="${d} L ${w-pad} ${h-pad} L ${pad} ${h-pad} Z" fill="rgba(47,184,107,.10)"/>
          </svg>
        `;
      }

      // å›ºå®šå°¾æ•¸ 980ï¼ˆå¾€ä¸Šå–æ•´ï¼‰
      function beautifyPriceUpTo980(x){
        if (!Number.isFinite(x)) return Infinity;
        x = Math.ceil(x);
        const base = Math.floor(x / 1000) * 1000;
        const candidate = base + FIXED_ENDING;
        if (candidate >= x) return candidate;
        return base + 1000 + FIXED_ENDING;
      }

      function safeNum(v, fallback){
        return Number.isFinite(v) ? v : fallback;
      }

      function compute(){
        // äººæ•¸ï¼ˆè‹¥æ²’å¡«ï¼Œå°±ç”¨ placeholder çš„ã€Œå»ºè­°å€¼ã€ç•¶ fallbackï¼‰
        const targetPeople  = Math.max(1, Math.floor(Number($("targetPeople").value) || 20));
        const desiredPeople = Math.max(1, Math.floor(Number($("desiredPeople").value) || 15));
        const earlyCount    = Math.max(0, Math.floor(Number($("earlyCount").value) || 0));
        const studentCount  = Math.max(0, Math.floor(Number($("studentCount").value) || 0));
        const normalCount   = Math.max(0, targetPeople - earlyCount - studentCount);

        // å”®åƒ¹
        let normalPrice = parseMoney($("priceNormal").value);
        const earlyDiscount = parseMoney($("earlyDiscount").value);
        const studentBuffer = parseMoney($("studentBuffer").value);
        const targetGM = clamp(((Number($("targetGM").value) || 20) / 100), 0, 0.95);

        // æˆæœ¬ï¼ˆæ²’å¡«å°±è¦–ç‚º NaNï¼Œé¿å…äº‚ç®—ï¼‰
        const japan = parseMoney($("costJapan").value);
        let flight  = parseMoney($("costFlight").value);
        const ins   = parseMoney($("costInsurance").value);
        const sim   = parseMoney($("costSim").value);
        const book  = parseMoney($("costBook").value);
        const bigBusExtraPer = parseMoney($("bigBusExtraPer").value);
        const extraPer = parseMoney($("costExtraPer").value);

        // å»£å‘Šèˆ‡å›ºå®š
        const adCostPerSignup = parseMoney($("adCostPerSignup").value);
        const fixedOther = parseMoney($("fixedOther").value);
        const fixed = safeNum(adCostPerSignup, 0) * targetPeople + safeNum(fixedOther, 0);

        // åˆ·å¡
        const cardCount = Math.max(0, Math.floor(Number($("cardCount").value) || 0));
        const feeRate = clamp(((Number($("cardFeeRate").value) || 0)/100), 0, 0.2);

        // æ¨¡å¼ï¼šä¸å«æ©Ÿç¥¨ï¼ˆå”®åƒ¹ -10000ã€æ©Ÿç¥¨æˆæœ¬=0ï¼‰
        if (ticketMode === "exclude"){
          flight = 0;
          if (Number.isFinite(normalPrice)) normalPrice = Math.max(0, normalPrice - 10000);
        }

        // åŸºç¤æˆæœ¬ï¼ˆåªåŠ ä¸Šæœ‰å¡«çš„éƒ¨åˆ†ï¼‰
        const baseCostParts = [japan, flight, ins, sim, book, bigBusExtraPer, extraPer].filter(Number.isFinite);
        const baseCost = baseCostParts.reduce((a,b)=>a+b, 0);

        // æ—©é³¥/å­¸å“¡åƒ¹æ ¼ï¼ˆè‹¥ä¸€èˆ¬åƒ¹æœªå¡«å°±ä¸ç®—ï¼‰
        const earlyPrice = (Number.isFinite(normalPrice) && Number.isFinite(earlyDiscount))
          ? Math.max(0, normalPrice - earlyDiscount)
          : NaN;

        const studentPrice = (Number.isFinite(baseCost) && Number.isFinite(studentBuffer))
          ? baseCost + studentBuffer
          : NaN;

        // å¹³å‡å”®åƒ¹ï¼ˆéœ€è¦è‡³å°‘ä¸€èˆ¬åƒ¹æœ‰å¡«ï¼‰
        const total = targetPeople;
        let avgPriceBeforeFee = NaN;
        if (Number.isFinite(normalPrice)){
          const earlyP = Number.isFinite(earlyPrice) ? earlyPrice : normalPrice;
          const studP  = Number.isFinite(studentPrice) ? studentPrice : normalPrice;
          avgPriceBeforeFee =
            (normalPrice * normalCount + earlyP * earlyCount + studP * studentCount) / Math.max(1, total);
        }

        // åˆ·å¡æ‰‹çºŒè²»ï¼ˆéœ€è¦ avgPriceBeforeFee æœ‰å€¼ï¼‰
        let avgCardFeePer = NaN;
        if (Number.isFinite(avgPriceBeforeFee)){
          const remainderPer = Math.max(0, avgPriceBeforeFee - DEPOSIT);
          const totalCardFee = remainderPer * cardCount * feeRate;
          avgCardFeePer = totalCardFee / Math.max(1, total);
        }

        // æ¯äººæˆæœ¬ï¼ˆéœ€è¦ baseCost æœ‰å€¼ï¼‰
        const costPer = Number.isFinite(baseCost)
          ? baseCost + (Number.isFinite(avgCardFeePer) ? avgCardFeePer : 0)
          : NaN;

        // æˆåœ˜ç·šï¼ˆéœ€è¦ avgPriceBeforeFee & costPerï¼‰
        let breakeven = Infinity;
        if (Number.isFinite(avgPriceBeforeFee) && Number.isFinite(costPer) && avgPriceBeforeFee > costPer){
          breakeven = Math.ceil(fixed / (avgPriceBeforeFee - costPer));
          breakeven = Math.max(1, breakeven);
        }

        const gmAt = (n) => {
          if (!Number.isFinite(avgPriceBeforeFee) || !Number.isFinite(costPer)) return NaN;
          const revenue = avgPriceBeforeFee * n;
          const cost = costPer * n + fixed;
          return revenue > 0 ? (revenue - cost) / revenue : NaN;
        };

        // 15äººæˆåœ˜å»ºè­°ä¸€èˆ¬åƒ¹ï¼ˆå›ºå®šå°¾æ•¸980ï¼‰
        let suggestedNormal = Infinity;
        if (Number.isFinite(costPer)){
          const avgRequired = costPer + (fixed / desiredPeople);
          const denom = (normalCount + earlyCount);
          if (denom > 0){
            const earlyD = Number.isFinite(earlyDiscount) ? earlyDiscount : 0;
            const studP  = Number.isFinite(studentPrice) ? studentPrice : (Number.isFinite(normalPrice) ? normalPrice : avgRequired);
            const rawNormal = (avgRequired * total + earlyD * earlyCount - studP * studentCount) / denom;
            suggestedNormal = beautifyPriceUpTo980(rawNormal);
          }
        }

        return {
          targetPeople, earlyCount, studentCount, normalCount, desiredPeople,
          normalPrice, earlyPrice, studentPrice,
          baseCost, avgCardFeePer, costPer,
          fixed, avgPriceBeforeFee,
          breakeven,
          gm15: gmAt(15),
          gm17: gmAt(RECOMMENDED_CAP),
          gmTarget: gmAt(targetPeople),
          targetGM,
          suggestedNormal,
          japan: safeNum(japan,0), flight: safeNum(flight,0),
          ins: safeNum(ins,0), sim: safeNum(sim,0), book: safeNum(book,0),
          bigBusExtraPer: safeNum(bigBusExtraPer,0), extraPer: safeNum(extraPer,0),
        };
      }

      function grossMarginRate(m, n){
        if (!Number.isFinite(m.avgPriceBeforeFee) || !Number.isFinite(m.costPer)) return NaN;
        const revenue = m.avgPriceBeforeFee * n;
        const cost = m.costPer * n + m.fixed;
        return revenue > 0 ? (revenue - cost) / revenue : NaN;
      }
      function grossProfit(m, n){
        if (!Number.isFinite(m.avgPriceBeforeFee) || !Number.isFinite(m.costPer)) return NaN;
        const revenue = m.avgPriceBeforeFee * n;
        const cost = m.costPer * n + m.fixed;
        return revenue - cost;
      }

      function setPillStyle(type){
        const el = $("riskPill");
        if (type === "danger"){
          el.style.borderColor = "rgba(240,90,90,.35)";
          el.style.color = "rgba(240,90,90,.95)";
        }else if (type === "warn"){
          el.style.borderColor = "rgba(255,176,32,.35)";
          el.style.color = "rgba(160,110,0,.95)";
        }else{
          el.style.borderColor = "rgba(47,184,107,.30)";
          el.style.color = "rgba(20,120,70,.95)";
        }
      }

      function renderMarginList(m, from, to){
        const rows = [];
        for (let n=from; n<=to; n++){
          const gm = grossMarginRate(m, n);
          const gp = grossProfit(m, n);

          let icon = "â€”";
          if (Number.isFinite(m.breakeven) && m.breakeven !== Infinity){
            if (n < m.breakeven) icon = "â›”";
            else if (Number.isFinite(gm) && gm < m.targetGM) icon = "âš ï¸";
            else icon = "âœ…";
          }

          rows.push(`
            <div class="item">
              <div class="left">
                <div class="badge">${icon}</div>
                <div class="meta">
                  <div class="t">${n} äºº</div>
                  <div class="s">å¹³å‡å”®åƒ¹ ${fmtMoney(m.avgPriceBeforeFee)} / äººã€€æ¯äººæˆæœ¬ ${fmtMoney(m.costPer)} / äººã€€å›ºå®šæˆæœ¬ ${fmtMoney(m.fixed)}</div>
                </div>
              </div>
              <div class="right">
                <div class="gm">${fmtPct(gm)}</div>
                <div class="gp">æ¯›åˆ© ${fmtMoney(gp)}</div>
              </div>
            </div>
          `);
        }
        $("marginList").innerHTML = rows.join("");
      }

      function render(){
        const m = compute();

        $("cntNormalTxt").textContent  = Number.isFinite(m.normalCount) ? `${m.normalCount}äºº` : "â€”";
        $("cntEarlyTxt").textContent   = Number.isFinite(m.earlyCount) ? `${m.earlyCount}äºº` : "â€”";
        $("cntStudentTxt").textContent = Number.isFinite(m.studentCount) ? `${m.studentCount}äºº` : "â€”";

        $("priceEarlyTxt").textContent   = fmtMoney(m.earlyPrice);
        $("priceStudentTxt").textContent = fmtMoney(m.studentPrice);

        $("avgPriceTxt").textContent = fmtMoney(m.avgPriceBeforeFee);
        $("costPerTxt").textContent  = fmtMoney(m.costPer);
        $("feeSubTxt").textContent   = `å°¾æ¬¾åˆ·å¡å¹³å‡æ‰‹çºŒè²»ï¼š${fmtMoney(m.avgCardFeePer)} / äºº`;
        $("fixedTxt").textContent    = fmtMoney(m.fixed);
        $("targetGmTxt").textContent = Number.isFinite(m.targetGM) ? Math.round(m.targetGM*100) + "%" : "â€”";

        if (m.targetPeople > RECOMMENDED_CAP){
          $("capNote").textContent = `ä½ å¡«çš„ç›®æ¨™äººæ•¸ ${m.targetPeople} äººè¶…é 17 äººï¼Œå¯èƒ½éœ€è¦å¤§å‹å·´å£«åŠ åƒ¹`;
          $("capNote").style.borderColor = "rgba(255,176,32,.35)";
        }else{
          $("capNote").textContent = "å»ºè­°å‡ºåœ˜äººæ•¸ï¼š17äººï¼ˆç›®å‰å·´å£«å¯è¼‰å­¸ç”Ÿä¸Šé™ï¼‰";
          $("capNote").style.borderColor = "rgba(0,0,0,.06)";
        }
        $("peopleHint").textContent = `å»ºè­°å‡ºåœ˜ï¼š17äººï½œç›®æ¨™äººæ•¸ï¼š${m.targetPeople}äºº`;

        $("busHint").textContent = (m.bigBusExtraPer > 0)
          ? `å·²åŠ å…¥å¤§å‹å·´å£«è¿½åŠ è²»ï¼š${fmtMoney(m.bigBusExtraPer)} / äºº`
          : `å¤§å‹å·´å£«è¿½åŠ è²»ç›®å‰æœªå¡«`;

        const p15 = m.targetGM > 0 && Number.isFinite(m.gm15) ? clamp(m.gm15 / m.targetGM, 0, 1) : 0;
        const p17 = m.targetGM > 0 && Number.isFinite(m.gm17) ? clamp(m.gm17 / m.targetGM, 0, 1) : 0;
        const pT  = m.targetGM > 0 && Number.isFinite(m.gmTarget) ? clamp(m.gmTarget / m.targetGM, 0, 1) : 0;

        setRing($("ring15"), p15, "var(--orange)");
        setRing($("ring17"), p17, "var(--gold)");
        setRing($("ringTarget"), pT, "var(--gold)");

        $("gm15Txt").textContent = fmtPct(m.gm15);
        $("gm17Txt").textContent = fmtPct(m.gm17);
        $("gmTargetTxt").textContent = fmtPct(m.gmTarget);

        if (m.breakeven === Infinity){
          $("breakevenTxt").textContent = "â€”";
          $("riskPill").textContent = "è³‡æ–™ä¸è¶³ï¼ˆè«‹å…ˆå¡«å”®åƒ¹èˆ‡æˆæœ¬ï¼‰";
          setPillStyle("warn");
        }else{
          $("breakevenTxt").textContent = `${m.breakeven} äºº`;
          if (m.targetPeople < m.breakeven){
            $("riskPill").textContent = "ç›®æ¨™äººæ•¸ä¸è¶³";
            setPillStyle("danger");
          }else if (Number.isFinite(m.gmTarget) && m.gmTarget < m.targetGM){
            $("riskPill").textContent = "å¯æˆåœ˜ï¼Œä½†æ¯›åˆ©åä½";
            setPillStyle("warn");
          }else{
            $("riskPill").textContent = "ç‹€æ…‹è‰¯å¥½";
            setPillStyle("ok");
          }
        }

        $("suggestNormalTxt").textContent =
          (Number.isFinite(m.suggestedNormal) && m.suggestedNormal !== Infinity)
            ? fmtMoney(m.suggestedNormal)
            : "NT$ â€”";

        // æˆæœ¬å †ç–Šï¼ˆæ²’æœ‰è³‡æ–™å°±ç©ºç™½ï¼‰
        const parts = [
          {name:"æ—¥æ–¹", value:m.japan, color:"rgba(42,125,255,.35)"},
          {name:"æ©Ÿç¥¨", value:m.flight, color:"rgba(255,106,43,.30)"},
          {name:"ä¿éšª", value:m.ins, color:"rgba(47,184,107,.28)"},
          {name:"ç¶²å¡", value:m.sim, color:"rgba(255,176,32,.28)"},
          {name:"æ‰‹å†Š", value:m.book, color:"rgba(0,0,0,.10)"},
          {name:"å·´å£«", value:m.bigBusExtraPer, color:"rgba(194,138,74,.25)"},
          {name:"å…¶ä»–", value:m.extraPer, color:"rgba(0,0,0,.06)"},
        ];
        const hasAny = parts.some(p=>p.value>0);
        $("costStack").innerHTML = hasAny ? $("costStack").innerHTML : "";
        if (hasAny) setMiniStack($("costStack"), parts);

        const from = Math.max(1, Math.floor(Number($("rangeFrom").value) || 10));
        const to   = Math.max(from, Math.floor(Number($("rangeTo").value) || 28));

        const pts = [];
        const steps = 10;
        for (let i=0;i<steps;i++){
          const n = from + (to-from) * (i/(steps-1));
          const gm = grossMarginRate(m, n);
          pts.push(Number.isFinite(gm) ? clamp(gm, 0, 1) : 0);
        }
        makeLineSVG($("sparkMargin"), pts);
        renderMarginList(m, from, to);
      }

      function attachMoney(id){
        const input = $(id);
        input.addEventListener("input", ()=>{
          formatCommaKeepCursor(input);
          render();
        });
        input.addEventListener("blur", ()=>{
          const v = parseMoney(input.value);
          if (Number.isFinite(v)) input.value = v.toLocaleString("zh-TW");
          render();
        });
      }

      function setMode(mode){
        ticketMode = mode;
        $("modeInclude").classList.toggle("active", mode==="include");
        $("modeExclude").classList.toggle("active", mode==="exclude");
        render();
      }

      function bind(){
        ["priceNormal","earlyDiscount","studentBuffer","costJapan","costFlight","costInsurance","costSim","costBook","bigBusExtraPer","costExtraPer","adCostPerSignup","fixedOther"]
          .forEach(attachMoney);

        ["targetPeople","earlyCount","studentCount","desiredPeople","targetGM","cardCount","cardFeeRate","rangeFrom","rangeTo"]
          .forEach(id=>{
            $(id).addEventListener("input", render);
            $(id).addEventListener("change", render);
          });

        $("modeInclude").addEventListener("click", ()=>setMode("include"));
        $("modeExclude").addEventListener("click", ()=>setMode("exclude"));

        $("resetBtn").addEventListener("click", ()=>{
          document.querySelectorAll("input").forEach(el => el.value = "");
          setMode("include");
        });
      }

      bind();
      setMode("include");
      render();
    });
  </script>
</body>
</html>
